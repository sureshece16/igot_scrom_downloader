// DOM Elements
const doIdsInput = document.getElementById('doIdsInput');
const startBtn = document.getElementById('startBtn');
const clearBtn = document.getElementById('clearBtn');
const progressSection = document.getElementById('progressSection');
const downloadSection = document.getElementById('downloadSection');
const totalCoursesEl = document.getElementById('totalCourses');
const completedCoursesEl = document.getElementById('completedCourses');
const scormFilesEl = document.getElementById('scormFiles');
const statusTextEl = document.getElementById('statusText');
const progressBar = document.getElementById('progressBar');
const progressPercentage = document.getElementById('progressPercentage');
const currentActivityEl = document.getElementById('currentActivity');
const logOutput = document.getElementById('logOutput');
const downloadZipBtn = document.getElementById('downloadZipBtn');
const startNewBtn = document.getElementById('startNewBtn');
const finalCoursesEl = document.getElementById('finalCourses');
const finalScormEl = document.getElementById('finalScorm');
const finalFailedEl = document.getElementById('finalFailed');
const summaryTextEl = document.getElementById('summaryText');
const copySummaryBtn = document.getElementById('copySummaryBtn');

let eventSource = null;
let downloadStats = {};

// Event Listeners
startBtn.addEventListener('click', startDownload);
clearBtn.addEventListener('click', clearInput);
downloadZipBtn.addEventListener('click', downloadZip);
startNewBtn.addEventListener('click', startNew);
copySummaryBtn.addEventListener('click', copySummary);

function clearInput() {
    doIdsInput.value = '';
    doIdsInput.focus();
}

function copySummary() {
    summaryTextEl.select();
    document.execCommand('copy');

    // Show feedback
    const originalText = copySummaryBtn.innerHTML;
    copySummaryBtn.innerHTML = '<span class="btn-icon">âœ…</span>Copied!';
    setTimeout(() => {
        copySummaryBtn.innerHTML = originalText;
    }, 2000);
}

function generateSummary(status) {
    const now = new Date();
    const timestamp = now.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    let summary = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“¦ iGOT SCORM DOWNLOAD SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Download Date: ${timestamp}

ðŸ“Š STATISTICS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Courses Processed:        ${status.courses_completed}/${status.total_courses}
ðŸ“š SCORM Files Found:         ${status.scorm_files_downloaded}
â¬‡ï¸  Successfully Downloaded:   ${status.scorm_files_downloaded - (downloadStats.failed_downloads || 0)}
âŒ Failed Downloads:          ${downloadStats.failed_downloads || 0}
ðŸ“¦ ZIP File:                  ${downloadStats.zip_filename || 'scorm_downloads.zip'}

`;

    if (downloadStats.errors && downloadStats.errors.length > 0) {
        summary += `âš ï¸  ERRORS ENCOUNTERED (${downloadStats.errors.length})
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`;
        downloadStats.errors.slice(0, 5).forEach((error, idx) => {
            summary += `${idx + 1}. ${error}\n`;
        });
        if (downloadStats.errors.length > 5) {
            summary += `... and ${downloadStats.errors.length - 5} more errors\n`;
        }
        summary += '\n';
    }

    summary += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generated by iGOT SCORM Downloader
${now.toISOString()}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

    return summary;
}

function startDownload() {
    const input = doIdsInput.value.trim();

    if (!input) {
        alert('Please enter at least one DO ID');
        return;
    }

    // Parse DO IDs (one per line)
    const doIds = input.split('\n')
        .map(id => id.trim())
        .filter(id => id.length > 0);

    if (doIds.length === 0) {
        alert('No valid DO IDs found');
        return;
    }

    // Disable start button
    startBtn.disabled = true;
    startBtn.textContent = 'Processing...';

    // Show progress section, hide download section
    progressSection.style.display = 'block';
    downloadSection.style.display = 'none';

    // Reset UI
    totalCoursesEl.textContent = doIds.length;
    completedCoursesEl.textContent = '0';
    scormFilesEl.textContent = '0';
    statusTextEl.textContent = 'Starting...';
    progressBar.style.width = '0%';
    progressPercentage.textContent = '0%';
    currentActivityEl.textContent = 'Initializing download...';
    logOutput.innerHTML = '';

    // Send request to backend
    fetch('/igot_scrom_downloader/api/download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ do_ids: doIds })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLog(`âœ… Download request accepted for ${data.total_courses} courses`);
                listenToProgress();
            } else {
                addLog(`âŒ Error: ${data.error}`);
                resetStartButton();
            }
        })
        .catch(error => {
            addLog(`âŒ Network error: ${error.message}`);
            resetStartButton();
        });
}

function listenToProgress() {
    // Close existing connection if any
    if (eventSource) {
        eventSource.close();
    }

    // Create new EventSource connection
    eventSource = new EventSource('/igot_scrom_downloader/api/progress');

    eventSource.onmessage = function (event) {
        const data = JSON.parse(event.data);

        // Update UI with status
        if (data.status) {
            updateProgress(data.status);
        }

        // Add message to log
        if (data.message && data.message !== '' && data.message !== 'DONE') {
            addLog(data.message);
            currentActivityEl.textContent = data.message;
        }

        // Check if download is complete
        if (data.message === 'DONE' || data.status.download_complete) {
            eventSource.close();
            showDownloadComplete(data.status);
        }
    };

    eventSource.onerror = function (error) {
        console.error('EventSource error:', error);
        eventSource.close();

        // Check if download actually completed by polling status
        checkDownloadStatus();
    };
}

function checkDownloadStatus() {
    fetch('/igot_scrom_downloader/api/status')
        .then(response => response.json())
        .then(status => {
            if (status.download_complete) {
                showDownloadComplete(status);
            } else if (!status.is_running) {
                // Download stopped but not complete
                addLog('âš ï¸ Download stopped unexpectedly');
                resetStartButton();
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
        });
}

function updateProgress(status) {
    // Update stats
    completedCoursesEl.textContent = status.courses_completed || 0;
    scormFilesEl.textContent = status.scorm_files_downloaded || 0;

    // Update status text
    if (status.is_running) {
        statusTextEl.textContent = 'Running';
        statusTextEl.style.color = 'var(--primary-orange)';
    } else if (status.download_complete) {
        statusTextEl.textContent = 'Complete';
        statusTextEl.style.color = 'var(--success)';
    } else {
        statusTextEl.textContent = 'Idle';
        statusTextEl.style.color = 'var(--text-muted)';
    }

    // Update progress bar
    const totalCourses = parseInt(totalCoursesEl.textContent) || 1;
    const completed = status.courses_completed || 0;
    const percentage = Math.round((completed / totalCourses) * 100);

    progressBar.style.width = `${percentage}%`;
    progressPercentage.textContent = `${percentage}%`;
}

function addLog(message) {
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.textContent = message;
    logOutput.appendChild(logEntry);

    // Auto-scroll to bottom
    logOutput.scrollTop = logOutput.scrollHeight;
}

function showDownloadComplete(status) {
    // Hide progress, show download section
    progressSection.style.display = 'none';
    downloadSection.style.display = 'block';

    // Store stats globally
    downloadStats = status;

    // Update final stats
    finalCoursesEl.textContent = status.courses_completed || 0;
    finalScormEl.textContent = status.scorm_files_downloaded || 0;
    finalFailedEl.textContent = status.failed_downloads || 0;

    // Generate and display summary
    const summary = generateSummary(status);
    summaryTextEl.value = summary;

    // Reset start button
    resetStartButton();
}

function resetStartButton() {
    startBtn.disabled = false;
    startBtn.innerHTML = '<span class="btn-icon">ðŸš€</span>Start Download';
}

function downloadZip() {
    window.location.href = '/igot_scrom_downloader/api/download-zip';
}

function startNew() {
    // Hide download section
    downloadSection.style.display = 'none';
    progressSection.style.display = 'none';

    // Clear input
    doIdsInput.value = '';
    doIdsInput.focus();

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Handle page unload
window.addEventListener('beforeunload', function () {
    if (eventSource) {
        eventSource.close();
    }
});
